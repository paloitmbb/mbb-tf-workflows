name: Reusable Terraform GitHub Provider CI

# ============================================================================
# GitHub Provider CI Workflow
# 
# This workflow provides CI for Terraform code using GitHub provider with
# HTTP backend state storage via GitHub Releases.
#
# Key features:
# - HTTP backend support (no Azure dependencies)
# - Security scans run in parallel (tfsec, Trivy)
# - Time savings: ~2-3 minutes (parallel execution)
# - SARIF upload to GitHub Security tab
# - PR comment with plan output
# - GitHub token authentication (ORG_GITHUB_TOKEN)
# ============================================================================

on:
  workflow_call:
    inputs:
      terraform-version:
        description: 'Terraform version (e.g., 1.7.0, 1.6.6, latest)'
        required: false
        type: string
        default: '1.7.0'
      
      working-directory:
        description: 'Working directory containing Terraform code'
        required: false
        type: string
        default: '.'
      
      environment:
        description: 'Target environment (dev, staging, prod)'
        required: true
        type: string
      
      # Security Scanner Toggles
      enable-tfsec:
        description: 'Enable tfsec Terraform security scanning'
        required: false
        type: boolean
        default: true
      
      enable-trivy:
        description: 'Enable Trivy security scanning'
        required: false
        type: boolean
        default: true
      
      # Linting
      enable-tflint:
        description: 'Enable tflint code quality linting'
        required: false
        type: boolean
        default: false
      
      tflint-version:
        description: 'tflint version to use'
        required: false
        type: string
        default: 'v0.60.0'
      
      # Security Scanner Severity Thresholds
      tfsec-severity:
        description: 'Minimum tfsec severity to fail (LOW, MEDIUM, HIGH, CRITICAL)'
        required: false
        type: string
        default: 'HIGH'
      
      trivy-severity:
        description: 'Minimum Trivy severity to fail (CRITICAL, HIGH, MEDIUM, LOW)'
        required: false
        type: string
        default: 'HIGH'
      
      # Continue-on-error Control (Audit Mode for Phase 1)
      tfsec-continue-on-error:
        description: 'Continue workflow if tfsec scan fails (recommended: true for visibility)'
        required: false
        type: boolean
        default: true
      
      trivy-continue-on-error:
        description: 'Continue workflow if Trivy scan fails (recommended: true for visibility)'
        required: false
        type: boolean
        default: true
      
      aggregate-continue-on-error:
        description: 'Continue workflow if security aggregation fails'
        required: false
        type: boolean
        default: true
      
      # Terraform
      terraform-var-file:
        description: 'Terraform variable file (e.g., dev.tfvars, prod.tfvars)'
        required: false
        type: string
        default: ''
      
      # HTTP Backend Configuration
      backend-config-file:
        description: 'Path to HTTP backend configuration file (e.g., backend.tfvars)'
        required: false
        type: string
        default: ''
      
      backend-config:
        description: 'Inline HTTP backend configuration (key=value pairs, newline-separated)'
        required: false
        type: string
        default: ''
      
      # PR Comment
      enable-pr-comment:
        description: 'Enable PR comment with plan output'
        required: false
        type: boolean
        default: true
      
      # Execution
      runner-os:
        description: 'Runner OS for all jobs'
        required: false
        type: string
        default: 'ubuntu-latest'
      
      timeout-minutes:
        description: 'Maximum execution time in minutes for plan job'
        required: false
        type: number
        default: 60
    
    secrets:
      ORG_GITHUB_TOKEN:
        description: 'GitHub PAT with repo and admin:org permissions for provider and HTTP backend'
        required: true
    
    outputs:
      # Validate outputs
      terraform-version:
        description: 'Installed Terraform version'
        value: ${{ jobs.validate.outputs.terraform-version }}
      fmt-status:
        description: 'Terraform format check status'
        value: ${{ jobs.validate.outputs.fmt-status }}
      validate-status:
        description: 'Terraform validate status'
        value: ${{ jobs.validate.outputs.validate-status }}
      tflint-status:
        description: 'tflint validation status'
        value: ${{ jobs.validate.outputs.tflint-status }}
      
      # Security outputs
      security-all-passed:
        description: 'Whether all enabled security scans passed (true/false)'
        value: ${{ jobs.aggregate-security.outputs.all-passed }}
      tfsec-status:
        description: 'tfsec scan status (success/failure/skipped)'
        value: ${{ jobs.aggregate-security.outputs.tfsec-status }}
      trivy-status:
        description: 'Trivy scan status (success/failure/skipped)'
        value: ${{ jobs.aggregate-security.outputs.trivy-status }}
      
      # Plan outputs
      plan-exitcode:
        description: 'Terraform plan exit code (0=no changes, 2=changes)'
        value: ${{ jobs.plan.outputs.exitcode }}

permissions:
  contents: read
  security-events: write
  id-token: write
  pull-requests: write

env:
  TF_IN_AUTOMATION: 'true'
  TF_INPUT: 'false'
  TF_CLI_ARGS: '-no-color'
  # GitHub provider authentication
  GITHUB_TOKEN: ${{ secrets.ORG_GITHUB_TOKEN }}
  # HTTP backend authentication
  TF_HTTP_PASSWORD: ${{ secrets.ORG_GITHUB_TOKEN }}

jobs:
  # ============================================================================
  # Job 1: Terraform Validation
  # ============================================================================
  validate:
    name: Validate Terraform (${{ inputs.environment }})
    runs-on: ${{ inputs.runner-os }}
    timeout-minutes: 15
    outputs:
      terraform-version: ${{ steps.setup-tf.outputs.terraform-version }}
      fmt-status: ${{ steps.validate.outputs.fmt-status }}
      validate-status: ${{ steps.validate.outputs.validate-status }}
      tflint-status: ${{ steps.validate.outputs.tflint-status }}
    
    steps:
      - name: Terraform Setup
        id: setup-tf
        uses: paloitmbb/mbb-tf-actions/actions/terraform-setup@main
        with:
          terraform-version: ${{ inputs.terraform-version }}
      
      - name: Terraform Init (Backend Disabled for Validation)
        uses: paloitmbb/mbb-tf-actions/actions/terraform-init@main
        with:
          working-directory: ${{ inputs.working-directory }}
          enable-backend: 'false'
      
      - name: Terraform Validate
        id: validate
        uses: paloitmbb/mbb-tf-actions/actions/terraform-validate@main
        with:
          working-directory: ${{ inputs.working-directory }}
          enable-tflint: ${{ inputs.enable-tflint }}
          tflint-version: ${{ inputs.tflint-version }}
      
      - name: Validation Results Summary
        if: always()
        shell: bash
        run: |
          echo "## ðŸ” Terraform Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Format (fmt) | ${{ steps.validate.outputs.fmt-status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Syntax (validate) | ${{ steps.validate.outputs.validate-status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Quality (tflint) | ${{ steps.validate.outputs.tflint-status }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Job 2: tfsec Security Scan
  # ============================================================================
  tfsec-scan:
    name: Security Scan - tfsec
    runs-on: ${{ inputs.runner-os }}
    timeout-minutes: 15
    if: inputs.enable-tfsec == true
    continue-on-error: ${{ inputs.tfsec-continue-on-error }}
    permissions:
      contents: read
      security-events: write
    outputs:
      outcome: ${{ steps.scan.outputs.outcome }}
    
    steps:
      - name: Terraform Setup
        uses: paloitmbb/mbb-tf-actions/actions/terraform-setup@main
        with:
          terraform-version: ${{ inputs.terraform-version }}
      
      - name: Terraform Init (Backend Disabled)
        uses: paloitmbb/mbb-tf-actions/actions/terraform-init@main
        with:
          working-directory: ${{ inputs.working-directory }}
          enable-backend: 'false'
      
      - name: tfsec Security Scan
        id: scan
        uses: paloitmbb/mbb-tf-actions/actions/scan-tfsec@main
        with:
          enabled: ${{ inputs.enable-tfsec }}
          working-directory: ${{ inputs.working-directory }}
          severity: ${{ inputs.tfsec-severity }}
          environment: ${{ inputs.environment }}
          var-file: ${{ inputs.terraform-var-file }}
          continue-on-error: ${{ inputs.tfsec-continue-on-error }}
      
      - name: Rename SARIF File
        id: rename
        if: always()
        uses: paloitmbb/mbb-tf-actions/actions/sarif-naming@main
        with:
          scanner-name: 'tfsec'
          source-file: 'tfsec-results.sarif'
          environment: ${{ inputs.environment }}
      
      - name: Upload SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@396bb3e45325a47dd769a2e68cad5aaf65f08867 # v3.27.5
        with:
          sarif_file: ${{ steps.rename.outputs.renamed-file }}
          category: tfsec-${{ inputs.environment }}

  # ============================================================================
  # Job 3: Trivy Security Scan
  # ============================================================================
  trivy-scan:
    name: Security Scan - Trivy
    runs-on: ${{ inputs.runner-os }}
    timeout-minutes: 15
    if: inputs.enable-trivy == true
    continue-on-error: ${{ inputs.trivy-continue-on-error }}
    permissions:
      contents: read
      security-events: write
    outputs:
      outcome: ${{ steps.scan.outputs.outcome }}
    
    steps:
      - name: Terraform Setup
        uses: paloitmbb/mbb-tf-actions/actions/terraform-setup@main
        with:
          terraform-version: ${{ inputs.terraform-version }}
      
      - name: Terraform Init (Backend Disabled)
        uses: paloitmbb/mbb-tf-actions/actions/terraform-init@main
        with:
          working-directory: ${{ inputs.working-directory }}
          enable-backend: 'false'
      
      - name: Trivy Security Scan
        id: scan
        uses: paloitmbb/mbb-tf-actions/actions/scan-trivy@main
        with:
          enabled: ${{ inputs.enable-trivy }}
          working-directory: ${{ inputs.working-directory }}
          severity: ${{ inputs.trivy-severity }}
          environment: ${{ inputs.environment }}
          continue-on-error: ${{ inputs.trivy-continue-on-error }}
      
      - name: Rename SARIF File
        id: rename
        if: always()
        uses: paloitmbb/mbb-tf-actions/actions/sarif-naming@main
        with:
          scanner-name: 'trivy'
          source-file: 'trivy-results.sarif'
          environment: ${{ inputs.environment }}
      
      - name: Upload SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@396bb3e45325a47dd769a2e68cad5aaf65f08867 # v3.27.5
        with:
          sarif_file: ${{ steps.rename.outputs.renamed-file }}
          category: trivy-${{ inputs.environment }}

  # ============================================================================
  # Job 4: Aggregate Security Results
  # ============================================================================
  aggregate-security:
    name: Aggregate Security Results
    needs: [tfsec-scan, trivy-scan]
    runs-on: ${{ inputs.runner-os }}
    timeout-minutes: 5
    continue-on-error: ${{ inputs.aggregate-continue-on-error }}
    if: always()
    outputs:
      all-passed: ${{ steps.aggregate.outputs.all-passed }}
      tfsec-status: ${{ steps.aggregate.outputs.tfsec-status }}
      trivy-status: ${{ steps.aggregate.outputs.trivy-status }}
    
    steps:
      - name: Aggregate Security Results
        id: aggregate
        uses: paloitmbb/mbb-tf-actions/actions/security-aggregate@main
        with:
          tfsec-enabled: ${{ inputs.enable-tfsec }}
          tfsec-outcome: ${{ needs.tfsec-scan.outputs.outcome || 'skipped' }}
          trivy-enabled: ${{ inputs.enable-trivy }}
          trivy-outcome: ${{ needs.trivy-scan.outputs.outcome || 'skipped' }}
      
      - name: Security Results Summary
        shell: bash
        run: |
          echo "## ðŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scanner | Status | Severity Threshold |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|-------------------|" >> $GITHUB_STEP_SUMMARY
          echo "| tfsec | ${{ steps.aggregate.outputs.tfsec-status }} | ${{ inputs.tfsec-severity }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Trivy | ${{ steps.aggregate.outputs.trivy-status }} | ${{ inputs.trivy-severity }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Overall Result:** ${{ steps.aggregate.outputs.all-passed == 'true' && 'âœ… PASSED' || 'âš ï¸ ISSUES FOUND (Audit Mode)' }}" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Job 5: Terraform Plan
  # ============================================================================
  plan:
    name: Generate Terraform Plan (${{ inputs.environment }})
    needs: [validate, aggregate-security]
    if: always() && needs.validate.result == 'success'
    runs-on: ${{ inputs.runner-os }}
    timeout-minutes: ${{ inputs.timeout-minutes }}
    outputs:
      exitcode: ${{ steps.plan.outputs.exitcode }}
    
    steps:
      - name: Terraform Setup
        id: setup-tf
        uses: paloitmbb/mbb-tf-actions/actions/terraform-setup@main
        with:
          terraform-version: ${{ inputs.terraform-version }}
      
      - name: Terraform Init (with HTTP Backend)
        uses: paloitmbb/mbb-tf-actions/actions/terraform-init@main
        with:
          working-directory: ${{ inputs.working-directory }}
          enable-backend: 'true'
          backend-type: 'http'
          backend-config-file: ${{ inputs.backend-config-file }}
          backend-config: ${{ inputs.backend-config }}
      
      - name: Generate Terraform Plan
        id: plan
        uses: paloitmbb/mbb-tf-actions/actions/terraform-plan@main
        with:
          working-directory: ${{ inputs.working-directory }}
          environment: ${{ inputs.environment }}
          terraform-version: ${{ steps.setup-tf.outputs.terraform-version }}
          var-file: ${{ inputs.terraform-var-file }}
          upload-artifacts: 'false'
          generate-attestation: 'false'
          generate-metadata: 'false'
          show-summary: 'true'
      
      - name: PR Comment with Plan
        if: github.event_name == 'pull_request' && inputs.enable-pr-comment == true
        uses: paloitmbb/mbb-tf-actions/actions/pr-comment-plan@main
        with:
          working-directory: ${{ inputs.working-directory }}
          environment: ${{ inputs.environment }}
          plan-exitcode: ${{ steps.plan.outputs.exitcode }}
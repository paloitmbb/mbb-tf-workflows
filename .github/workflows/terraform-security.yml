name: Reusable Terraform Security Scans

# ============================================================================
# Terraform Validation + Security Workflow
# 
# This workflow validates Terraform code and runs security scans in parallel.
# Includes plan preview generation for PR reviews (requires Azure credentials).
#
# Key features:
# - Terraform validation (fmt, validate, tflint)
# - Security scans run in parallel (tfsec, trivy)
# - Plan preview with Azure OIDC authentication for PR feedback
# - Time savings: ~3-5 minutes (parallel vs sequential)
# - Conditional scanner enablement via inputs
# - Uses common-setup and security-aggregate composite actions
# ============================================================================

on:
  workflow_call:
    inputs:
      terraform-version:
        description: 'Terraform version (e.g., 1.7.0, 1.6.6, latest)'
        required: false
        type: string
        default: '1.7.0'
      
      working-directory:
        description: 'Working directory containing Terraform code'
        required: false
        type: string
        default: '.'
      
      environment:
        description: 'Target environment (dev, staging, prod)'
        required: true
        type: string
      
      # Security Scanner Toggles
      enable-tfsec:
        description: 'Enable tfsec Terraform security scanning'
        required: false
        type: boolean
        default: true
      
      enable-trivy:
        description: 'Enable Trivy security scanning'
        required: false
        type: boolean
        default: true
      
      # Security Scanner Severity Thresholds
      tfsec-severity:
        description: 'Minimum tfsec severity to fail (LOW, MEDIUM, HIGH, CRITICAL)'
        required: false
        type: string
        default: 'HIGH'
      
      trivy-severity:
        description: 'Minimum Trivy severity to fail (CRITICAL, HIGH, MEDIUM, LOW)'
        required: false
        type: string
        default: 'HIGH'
      
      # Continue-on-error Control
      tfsec-continue-on-error:
        description: 'Continue workflow if tfsec scan fails (recommended: true for visibility)'
        required: false
        type: boolean
        default: true
      
      trivy-continue-on-error:
        description: 'Continue workflow if Trivy scan fails (recommended: true for visibility)'
        required: false
        type: boolean
        default: true
      
      aggregate-continue-on-error:
        description: 'Continue workflow if security aggregation fails'
        required: false
        type: boolean
        default: true
      
      plan-continue-on-error:
        description: 'Continue workflow if plan generation fails'
        required: false
        type: boolean
        default: true
      
      # Linting
      enable-tflint:
        description: 'Enable tflint code quality linting'
        required: false
        type: boolean
        default: true
      
      tflint-version:
        description: 'tflint version to use'
        required: false
        type: string
        default: 'v0.60.0'
      
      # Terraform
      terraform-var-file:
        description: 'Terraform variable file (e.g., dev.tfvars, prod.tfvars)'
        required: false
        type: string
        default: ''
      
      # Execution
      runner-os:
        description: 'Default runner OS for all jobs (can be overridden per job)'
        required: false
        type: string
        default: 'ubuntu-latest'
      
      validate-runner-os:
        description: 'Runner OS for validation job (defaults to runner-os)'
        required: false
        type: string
        default: ''
      
      security-runner-os:
        description: 'Runner OS for security scan jobs (defaults to runner-os)'
        required: false
        type: string
        default: ''
      
      plan-runner-os:
        description: 'Runner OS for plan job (defaults to runner-os)'
        required: false
        type: string
        default: ''
      
      # Azure Storage for SARIF Upload
      sarif-storage-account-name:
        description: 'Azure Storage Account name for SARIF uploads (leave empty to skip upload)'
        required: false
        type: string
        default: ''
      
      sarif-storage-container-name:
        description: 'Azure Storage Container name for SARIF uploads'
        required: false
        type: string
        default: 'security-scans'
      
      sarif-storage-destination-path:
        description: 'Destination path prefix in blob storage (e.g., sarif-results/)'
        required: false
        type: string
        default: 'sarif-results/'
    
    secrets:
      GH_TOKEN:
        description: 'GitHub token with read access to reusable workflows repo (use PAT for private repos)'
        required: false
      
      # Azure OIDC Authentication (required for plan generation)
      AZURE_CLIENT_ID:
        description: 'Azure Application (Client) ID for OIDC authentication'
        required: true
      AZURE_TENANT_ID:
        description: 'Azure Directory (Tenant) ID for OIDC authentication'
        required: true
      AZURE_SUBSCRIPTION_ID:
        description: 'Azure Subscription ID for OIDC authentication'
        required: true
    
    outputs:
      # Validate outputs
      terraform-version:
        description: 'Installed Terraform version'
        value: ${{ jobs.validate.outputs.terraform-version }}
      fmt-status:
        description: 'terraform fmt validation status'
        value: ${{ jobs.validate.outputs.fmt-status }}
      validate-status:
        description: 'terraform validate status'
        value: ${{ jobs.validate.outputs.validate-status }}
      tflint-status:
        description: 'tflint validation status'
        value: ${{ jobs.validate.outputs.tflint-status }}
      
      # Security outputs
      security-all-passed:
        description: 'Whether all enabled security scans passed (true/false)'
        value: ${{ jobs.aggregate-security.outputs.all-passed }}
      tfsec-status:
        description: 'tfsec scan status (success/failure/skipped)'
        value: ${{ jobs.aggregate-security.outputs.tfsec-status }}
      trivy-status:
        description: 'Trivy scan status (success/failure/skipped)'
        value: ${{ jobs.aggregate-security.outputs.trivy-status }}
      
      # Plan outputs
      plan-exitcode:
        description: 'Terraform plan exit code (0=no changes, 2=changes)'
        value: ${{ jobs.plan.outputs.exitcode }}
      plan-has-changes:
        description: 'Whether plan detected changes (true/false)'
        value: ${{ jobs.plan.outputs.has-changes }}
      plan-summary:
        description: 'Summary of plan changes'
        value: ${{ jobs.plan.outputs.plan-summary }}

permissions:
  contents: read
  security-events: write
  actions: read
  id-token: write      # Required for Azure OIDC authentication in plan job

env:
  TF_IN_AUTOMATION: 'true'
  TF_INPUT: 'false'
  TF_CLI_ARGS: '-no-color'

jobs:
  # ============================================================================
  # Job 1: Terraform Validation
  # ============================================================================
  validate:
    name: Validate Terraform (${{ inputs.environment }})
    runs-on: ${{ inputs.validate-runner-os || inputs.runner-os }}
    timeout-minutes: 15
    outputs:
      terraform-version: ${{ steps.setup-tf.outputs.terraform-version }}
      fmt-status: ${{ steps.validate.outputs.fmt-status }}
      validate-status: ${{ steps.validate.outputs.validate-status }}
      tflint-status: ${{ steps.validate.outputs.tflint-status }}
    
    steps:
      - name: Common Setup
        id: setup-tf
        uses: paloitmbb/mbb-tf-actions/actions/terraform-setup@main
        with:
          terraform-version: ${{ inputs.terraform-version }}
      
      - name: Terraform Init (Backend Disabled)
        uses: paloitmbb/mbb-tf-actions/actions/terraform-init@main
        with:
          working-directory: ${{ inputs.working-directory }}
          enable-backend: 'false'
      
      - name: Terraform Validate
        id: validate
        uses: paloitmbb/mbb-tf-actions/actions/terraform-validate@main
        with:
          working-directory: ${{ inputs.working-directory }}
          enable-tflint: ${{ inputs.enable-tflint }}
          tflint-version: ${{ inputs.tflint-version }}

  # ============================================================================
  # Job 2: tfsec Security Scan
  # ============================================================================
  tfsec-scan:
    name: Security Scan - tfsec
    runs-on: ${{ inputs.security-runner-os || inputs.runner-os }}
    timeout-minutes: 15
    if: inputs.enable-tfsec == true
    continue-on-error: ${{ inputs.tfsec-continue-on-error }}
    permissions:
      id-token: write      # Required for Azure OIDC authentication
      contents: read
      security-events: write
    outputs:
      outcome: ${{ steps.scan.outputs.outcome }}
    
    steps:
      - name: Common Setup
        uses: paloitmbb/mbb-tf-actions/actions/terraform-setup@main
        with:
          terraform-version: ${{ inputs.terraform-version }}
      
      - name: Terraform Init (Backend Disabled)
        uses: paloitmbb/mbb-tf-actions/actions/terraform-init@main
        with:
          working-directory: ${{ inputs.working-directory }}
          enable-backend: 'false'
      
      - name: tfsec Security Scan
        id: scan
        uses: paloitmbb/mbb-tf-actions/actions/scan-tfsec@main
        with:
          enabled: ${{ inputs.enable-tfsec }}
          working-directory: ${{ inputs.working-directory }}
          severity: ${{ inputs.tfsec-severity }}
          environment: ${{ inputs.environment }}
          var-file: ${{ inputs.terraform-var-file }}
          continue-on-error: ${{ inputs.tfsec-continue-on-error }}
      
      - name: Rename SARIF File
        id: rename
        if: always()
        uses: paloitmbb/mbb-tf-actions/actions/sarif-naming@main
        with:
          scanner-name: 'tfsec'
          source-file: 'tfsec-results.sarif'
          environment: ${{ inputs.environment }}
      
      - name: Azure OIDC Login
        if: always() && inputs.sarif-storage-account-name != ''
        uses: paloitmbb/mbb-tf-actions/actions/azure-oidc-login@main
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Upload SARIF to Azure Storage
        if: always() && inputs.sarif-storage-account-name != ''
        uses: paloitmbb/mbb-tf-actions/actions/azure-blobstorage-upload@main
        with:
          storage-account-name: ${{ inputs.sarif-storage-account-name }}
          container-name: ${{ inputs.sarif-storage-container-name }}
          source-path: ${{ steps.rename.outputs.renamed-file }}
          destination-path: ${{ inputs.sarif-storage-destination-path }}
          content-type: 'application/sarif+json'
          overwrite: 'true'

  # ============================================================================
  # Job 3: Trivy Security Scan
  # ============================================================================
  trivy-scan:
    name: Security Scan - trivy
    runs-on: ${{ inputs.security-runner-os || inputs.runner-os }}
    timeout-minutes: 15
    if: inputs.enable-trivy == true
    continue-on-error: ${{ inputs.trivy-continue-on-error }}
    permissions:
      id-token: write      # Required for Azure OIDC authentication
      contents: read
      security-events: write
    outputs:
      outcome: ${{ steps.scan.outputs.outcome }}
    
    steps:
      - name: Common Setup
        uses: paloitmbb/mbb-tf-actions/actions/terraform-setup@main
        with:
          terraform-version: ${{ inputs.terraform-version }}
      
      - name: Terraform Init (Backend Disabled)
        uses: paloitmbb/mbb-tf-actions/actions/terraform-init@main
        with:
          working-directory: ${{ inputs.working-directory }}
          enable-backend: 'false'
      
      - name: Trivy Security Scan
        id: scan
        uses: paloitmbb/mbb-tf-actions/actions/scan-trivy@main
        with:
          enabled: ${{ inputs.enable-trivy }}
          working-directory: ${{ inputs.working-directory }}
          severity: ${{ inputs.trivy-severity }}
          environment: ${{ inputs.environment }}
          continue-on-error: ${{ inputs.trivy-continue-on-error }}
      
      - name: Rename SARIF File
        id: rename
        if: always()
        uses: paloitmbb/mbb-tf-actions/actions/sarif-naming@main
        with:
          scanner-name: 'trivy'
          source-file: 'trivy-results.sarif'
          environment: ${{ inputs.environment }}
      
      - name: Azure OIDC Login
        if: always() && inputs.sarif-storage-account-name != ''
        uses: paloitmbb/mbb-tf-actions/actions/azure-oidc-login@main
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Upload SARIF to Azure Storage
        if: always() && inputs.sarif-storage-account-name != ''
        uses: paloitmbb/mbb-tf-actions/actions/azure-blobstorage-upload@main
        with:
          storage-account-name: ${{ inputs.sarif-storage-account-name }}
          container-name: ${{ inputs.sarif-storage-container-name }}
          source-path: ${{ steps.rename.outputs.renamed-file }}
          destination-path: ${{ inputs.sarif-storage-destination-path }}
          content-type: 'application/sarif+json'
          overwrite: 'true'

  # ============================================================================
  # Job 4: Aggregate Security Results
  # ============================================================================
  aggregate-security:
    name: Aggregate Security Results
    needs: [tfsec-scan, trivy-scan]
    runs-on: ${{ inputs.security-runner-os || inputs.runner-os }}
    timeout-minutes: 5
    continue-on-error: ${{ inputs.aggregate-continue-on-error }}
    if: always()
    outputs:
      all-passed: ${{ steps.aggregate.outputs.all-passed }}
      tfsec-status: ${{ steps.aggregate.outputs.tfsec-status }}
      trivy-status: ${{ steps.aggregate.outputs.trivy-status }}
    
    steps:
      - name: Aggregate Security Results
        id: aggregate
        uses: paloitmbb/mbb-tf-actions/actions/security-aggregate@main
        with:
          tfsec-enabled: ${{ inputs.enable-tfsec }}
          tfsec-outcome: ${{ needs.tfsec-scan.outputs.outcome || 'skipped' }}
          trivy-enabled: ${{ inputs.enable-trivy }}
          trivy-outcome: ${{ needs.trivy-scan.outputs.outcome || 'skipped' }}
      
      - name: Security Results Summary
        shell: bash
        run: |
          echo "## ðŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scanner | Status | Severity Threshold |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|-------------------|" >> $GITHUB_STEP_SUMMARY
          echo "| tfsec | ${{ steps.aggregate.outputs.tfsec-status }} | ${{ inputs.tfsec-severity }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Trivy | ${{ steps.aggregate.outputs.trivy-status }} | ${{ inputs.trivy-severity }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Overall Result:** ${{ steps.aggregate.outputs.all-passed == 'true' && 'âœ… PASSED' || 'âŒ FAILED' }}" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Job 5: Terraform Plan Preview (with Azure OIDC)
  # ============================================================================
  plan:
    name: Generate Plan Preview (${{ inputs.environment }})
    needs: [validate]
    if: always() && needs.validate.result == 'success'
    runs-on: ${{ inputs.plan-runner-os || inputs.runner-os }}
    timeout-minutes: 15
    continue-on-error: ${{ inputs.plan-continue-on-error }}
    permissions:
      id-token: write      # Required for Azure OIDC authentication
      contents: read
    outputs:
      exitcode: ${{ steps.plan.outputs.exitcode }}
      has-changes: ${{ steps.plan.outputs.has-changes }}
      plan-summary: ${{ steps.plan.outputs.plan-summary }}
    
    steps:
      - name: Common Setup
        id: setup-tf
        uses: paloitmbb/mbb-tf-actions/actions/terraform-setup@main
        with:
          terraform-version: ${{ inputs.terraform-version }}
      
      - name: Azure OIDC Login
        uses: paloitmbb/mbb-tf-actions/actions/azure-oidc-login@main
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Terraform Init (Backend Enabled)
        uses: paloitmbb/mbb-tf-actions/actions/terraform-init@main
        with:
          working-directory: ${{ inputs.working-directory }}
          enable-backend: 'true'
      
      - name: Generate Terraform Plan Preview
        id: plan
        uses: paloitmbb/mbb-tf-actions/actions/terraform-plan@main
        with:
          working-directory: ${{ inputs.working-directory }}
          environment: ${{ inputs.environment }}
          terraform-version: ${{ steps.setup-tf.outputs.terraform-version }}
          var-file: ${{ inputs.terraform-var-file }}
          upload-artifacts: 'false'
          generate-attestation: 'false'
          generate-metadata: 'false'
          show-summary: 'true'

  # ============================================================================
  # Job 6: PR Comment (Security + Plan Results)
  # ============================================================================
  pr-comment:
    name: Comment on PR
    needs: [validate, aggregate-security, plan]
    if: always() && github.event_name == 'pull_request'
    runs-on: ${{ inputs.plan-runner-os || inputs.runner-os }}
    timeout-minutes: 5
    permissions:
      pull-requests: write
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
      
      - name: PR Comment with Security & Plan Results
        uses: paloitmbb/mbb-tf-actions/actions/pr-comment-plan@main
        with:
          working-directory: ${{ inputs.working-directory }}
          environment: ${{ inputs.environment }}
          terraform-version: ${{ needs.validate.outputs.terraform-version }}
          plan-summary: ${{ needs.plan.outputs.plan-summary }}
          plan-exitcode: ${{ needs.plan.outputs.plan-exitcode }}
          github-token: ${{ secrets.GH_TOKEN || github.token }}
          # Validation statuses
          fmt-status: ${{ needs.validate.outputs.fmt-status }}
          validate-status: ${{ needs.validate.outputs.validate-status }}
          tflint-status: ${{ needs.validate.outputs.tflint-status }}
          # Security statuses
          tfsec-status: ${{ needs.aggregate-security.outputs.tfsec-status }}
          tfsec-severity: ${{ inputs.tfsec-severity }}

          trivy-status: ${{ needs.aggregate-security.outputs.trivy-status }}
          trivy-severity: ${{ inputs.trivy-severity }}
          security-passed: ${{ needs.aggregate-security.outputs.all-passed }}


# Example: PR Security Check with Plan Preview
#
# This workflow calls terraform-security.yml for PR validation with
# tfsec + Trivy scanning and a plan preview.
#
# Use this for: Pull request validation before code review
# Estimated time: ~5-6 minutes (parallel scanners)

name: PR Security & Plan Preview

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'env/**'
      - 'modules/**'
      - '**.tf'
      - '**.tfvars'
  
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      severity:
        description: 'Security scan severity threshold'
        type: choice
        options:
          - CRITICAL
          - HIGH
          - MEDIUM
          - LOW
        default: HIGH

# Required permissions for security workflow
permissions:
  contents: read          # Checkout code
  security-events: write  # Upload SARIF to Security tab
  id-token: write         # Azure OIDC authentication (for plan preview)
  actions: read           # SARIF upload telemetry

jobs:
  # ============================================================================
  # Determine target environment from PR target branch
  # ============================================================================
  prepare:
    name: Determine Target Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      working-directory: ${{ steps.set-env.outputs.working-directory }}
    
    steps:
      - name: Determine Environment from Target Branch
        id: set-env
        run: |
          TARGET_BRANCH="${{ github.base_ref || github.ref_name }}"
          
          if [[ "$TARGET_BRANCH" == "main" ]]; then
            ENV="prod"
          elif [[ "$TARGET_BRANCH" == "develop" ]]; then
            ENV="stage"
          else
            ENV="dev"
          fi
          
          echo "environment=${ENV}" >> $GITHUB_OUTPUT
          echo "working-directory=./env/${ENV}" >> $GITHUB_OUTPUT
          
          echo "## ðŸ“ Target Environment" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${TARGET_BRANCH} â†’ **Environment:** ${ENV}" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Run security scans and plan preview
  # ============================================================================
  security-and-plan:
    name: Security & Plan (${{ needs.prepare.outputs.environment }})
    needs: prepare
    uses: paloitmbb/mbb-tf-workflows/.github/workflows/terraform-security.yml@main
    with:
      # Terraform Configuration
      terraform-version: '1.7.0'
      working-directory: ${{ needs.prepare.outputs.working-directory }}
      environment: ${{ needs.prepare.outputs.environment }}
      terraform-var-file: 'terraform.tfvars'
      
      # Code Quality
      enable-tflint: true
      tflint-version: 'v0.60.0'
      
      # Security Scanners
      enable-tfsec: true
      enable-trivy: true
      
      # Use manual severity input if provided, otherwise use HIGH
      tfsec-severity: ${{ github.event.inputs.severity || 'HIGH' }}
      trivy-severity: ${{ github.event.inputs.severity || 'HIGH' }}
      
      # Continue-on-error Control (allow all scans for reporting)
      tfsec-continue-on-error: true        # Run all scans
      trivy-continue-on-error: true        # All findings captured
      aggregate-continue-on-error: true    # Let security-gate handle failure
      
      # Execution
      runner-os: 'ubuntu-latest'
    
    secrets:
      # Azure OIDC Authentication (required for plan preview with backend access)
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      # Optional: GitHub token for private module access
      # GH_TOKEN: ${{ secrets.GH_TOKEN }}

  # ============================================================================
  # Block merge if security checks fail
  # ============================================================================
  security-gate:
    name: Security Gate
    needs: [prepare, security-and-plan]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Check Security Results
        run: |
          echo "## ðŸ”’ Security Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.prepare.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**All Security Scans Passed:** ${{ needs.security-and-plan.outputs.security-all-passed }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scanner | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| tfsec | ${{ needs.security-and-plan.outputs.tfsec-status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Trivy | ${{ needs.security-and-plan.outputs.trivy-status }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.security-and-plan.outputs.security-all-passed }}" != "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **Security checks failed - PR cannot be merged**" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **All security checks passed - PR ready for review**" >> $GITHUB_STEP_SUMMARY
          fi
